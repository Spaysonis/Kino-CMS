{% extends 'cms/statistics.html' %}

{%block content%}



<form class="ajax-top-banner-form" data-banner="top-banner"  method="POST" enctype="multipart/form-data" name="top_banner" action="{% url 'banners' %}">
    {% csrf_token %}
    <!--!!!!ВЕРХНИЙ БАННЕР!!!! -->
    <div class="card text-center">
      <div class="card-header">
        На главной вверх
      </div>





      <div class="card-body">

          <div class="d-flex justify-content-end align-items-center">
              <label for="newsStatusToggle" class="mb-0 mr-2">
                  статус
              </label>
              {{top_banner_form.is_active}}
              {{top_banner_form.is_active.value}}
          </div>

          <div   class="d-flex justify-content-left" >
              <h4>Size: 1000x190</h4>
          </div>

          <div class="top-banner-wrapper" id="top_banner-wrapper">
              <div class="row ml-2 mt-2" id="top_banner-container">
                  {{ top_banner_formset.management_form  }}
                  {%for form in top_banner_formset %}

                   <div class="col-md-2 top-banner-item mb-3">
                       {{ form.id }}
                       <div style="display: none">{{ form.DELETE }}</div>
                            <!-- Кнопка удалить -->

                       <button type="button" class="btn btn-danger w-100 mb-2 remove-image">Удалить</button>
                       {% if form.instance.pk and form.instance.image %}
                       <img class="card-img-top preview mb-2"
                                 src="{{form.instance.image.url}}" alt="...">
                       {%else%}
                       <img class="card-img-top preview mb-2" src="https://www.nomadfoods.com/wp-content/uploads/2018/08/placeholder-1-e1533569576673-960x960.png" alt="...">
                       {%endif%}
                       <button type="button" class="btn btn-success w-100 mb-2 upload-btn">Загрузить</button>
                       {{ form.image }}
                       {{ form.url}}
                       {{ form.text}}
                   </div>
                  {%endfor%}
              </div>


              <div class="row ml-2">
                  <div class="col-md-2">
                      <button type="button" class="btn btn-primary w-100" id="btn-add-top-banner-item">
                          <i class="fas fa-plus"></i> Добавить
                      </button>
                  </div>
              </div>

              <div id="empty-top-banner-form" style="display: none;">
                {% with form=top_banner_formset.empty_form %}
                  <div class="col-md-2 top-banner-item mb-3">
                      {{ form.id }}
                      <div style="display: none;">{{form.DELETE }}</div>
                      <button type="button" class="btn btn-danger w-100 mb-2 remove-image">Удалить</button>
                      <img src="https://www.nomadfoods.com/wp-content/uploads/2018/08/placeholder-1-e1533569576673-960x960.png" class="card-img-top preview mb-2" alt="placeholder">
                      <button type="button" class="btn btn-success w-100 mb-2 upload-btn">Загрузить</button>
                      {{ form.image }}
                      {{ form.url}}
                      {{ form.text}}

                  </div>
                  {% endwith %}
              </div>

          </div>
      </div>




      <div class="card-footer text-muted ">

        <div class="btn-toolbar ml-3" role="toolbar" aria-label="Toolbar with button groups">
            <h4 class="mr-5">Speed rotation</h4>
            {{ top_banner_form.speed }}
            <div class="btn-group mr-2" role="group" aria-label="First group">
                <button type="button" class="btn btn-secondary" data-value="1">1</button>
                <button type="button" class="btn btn-secondary" data-value="2">2</button>
                <button type="button" class="btn btn-secondary" data-value="3">3</button>
                <button type="button" class="btn btn-secondary" data-value="4">4</button>
                <button type="button" class="btn btn-secondary" data-value="5">5</button>
            </div>
        </div>
          <div class="d-flex justify-content-center">
              <button type="submit" class=" btn btn-success ">Success</button>
          </div>
      </div>

    </div>

    <!--ЗАКРЫЛ ВЕРХНИЙ БАННЕР-->
</form>



<!--!!!!!БАННЕР НА ЗАДНЕМ ФОНЕ-->
<div class="card text-center">
  <div class="card-header">
    Сквозной баннер на заднем фоне
  </div>

  <div class="card-body">
    <h5 class="card-title mr-5">Фото на задний фон</h5>
      <div class="row">
          <div class="card col-md-2" style="width: 20rem;">
              {% if banner_form.instance.image %}
              <img id="mainImagePreview" src="{{banner_form.instance.image.url}}"  class="card-img-top"  alt="">
              {% else %}
              <img id='mainImagePreview' src="https://www.nomadfoods.com/wp-content/uploads/2018/08/placeholder-1-e1533569576673-960x960.png" class="card-img-top" alt="...">
              {% endif %}
          </div>
          <div  class="col-md-2">
              <button type="button"  id="uploadLogoBtn" class="btn btn-success">Загрузить</button>
              {{ banner_form.image }}
          </div>
          <div  class="col-md-2">
              <button type="button" id="deleteLogoBtn" class="btn btn-danger ml-3">Удалить</button>
          </div>
      </div>
  </div>
  <div class="card-footer text-muted">
    2 days ago
  </div>
</div>
<!--ЗАКРЫЛ БАННЕР НА ЗАДНЕМ ФОНЕ!! !-->




<!--!!! БАННЕР НА ГЛАНОЙ НОВОСТИ И АКЦИИ !! -->
<form class="ajax-news-banner-form" data-banner="news-banner"  method="POST" enctype="multipart/form-data" name="news_banner" action="{% url 'banners' %}">
    <div class="card text-center">
      <div class="card-header">

        На главной новости и акции
      </div>

      <div class="card-body">

          <div class="d-flex justify-content-end align-items-center">
              <label for="newsStatusToggle1" class="mb-0 mr-2">
                  статус
              </label>
              {{news_banner_form.is_active}}
          </div>

          <div   class="d-flex justify-content-left" >
              <h4>Size: 1000x190</h4>
          </div>

          <div id="news_banner-wrapper">
              <div class="row ml-2 mt-2" id="news_banner-container">
                  {{ news_banner_formset.management_form  }}
                  {%for form in news_banner_formset %}
                  {{ form.id }}
                   <div style="">
                            {{ form.DELETE }}
                   </div>
                   <div class="col-md-2 news-banner-item mb-3">
                            <!-- Кнопка удалить -->
                       <button type="button" class="btn btn-danger w-100 mb-2 remove-image">Удалить</button>
                       {% if form.instance.pk and form.instance.image %}
                       <img class="card-img-top preview mb-2"
                                 src="{{form.instance.image.url}}" alt="...">
                       {%else%}
                       <img class="card-img-top preview mb-2" src="https://www.nomadfoods.com/wp-content/uploads/2018/08/placeholder-1-e1533569576673-960x960.png" alt="...">
                       {%endif%}
                       <button type="button" class="btn btn-success w-100 mb-2 upload-btn">Загрузить</button>
                       {{ form.image }}
                       {{ form.url}}

                   </div>
                  {%endfor%}
              </div>



              <div class="row ml-2">
                  <div class="col-md-2">
                      <button type="button" class="btn btn-primary w-100" id="btn-add-news-banner-item">
                          <i class="fas fa-plus"></i> Добавить
                      </button>
                  </div>
              </div>


              <div id="empty-news-banner-form" style="display: none;">
                {% with form=top_banner_formset.empty_form %}
                  <div class="col-md-2 news-banner-item mb-3">
                      {{ form.id }}
                      <div style="display: none;">{{form.DELETE }}</div>
                      <button type="button" class="btn btn-danger w-100 mb-2 remove-image">Удалить</button>
                      <img src="https://www.nomadfoods.com/wp-content/uploads/2018/08/placeholder-1-e1533569576673-960x960.png" class="card-img-top preview mb-2" alt="placeholder">

                      <button type="button" class="btn btn-success w-100 mb-2 upload-btn">Загрузить</button>
                      {{ form.image }}
                       {{ form.url}}
                  </div>
                  {% endwith %}
              </div>
          </div>

      </div>




      <div class="card-footer text-muted ">


        <div class="btn-toolbar ml-3" role="toolbar" aria-label="Toolbar with button groups">
            <h4 class="mr-5">Speed rotation</h4>
            <div class="btn-group mr-2" role="group" aria-label="First group">
                <button type="button" class="btn btn-secondary">1</button>
                <button type="button" class="btn btn-secondary">2</button>
                <button type="button" class="btn btn-secondary">3</button>
                <button type="button" class="btn btn-secondary">4</button>
                <button type="button" class="btn btn-secondary">5</button>
            </div>

        </div>

          <div class="d-flex justify-content-center">
              <button type="submit" class=" btn btn-success ">Success</button>
          </div>


      </div>
    </div>
</form>

<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Успешно!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Изменения сохранены успешно.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!--!!ЗАКРЫЛ БАНННЕР НОВОСТИ И АКЦИИ !!! -->

<script>


document.addEventListener('DOMContentLoaded', function () {

    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // cookie начинается с name=
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


    const top_banner_form = document.querySelector('.ajax-top-banner-form');
    top_banner_form.addEventListener('submit', function (even){
        even.preventDefault() ; // preventDefault - отменяет перезагрузку страници, меняет стандартное поведение браузерв

        // собираю все данные с формы
        const top_banner_data = new FormData(top_banner_form) // FormData - собирает все поля формы
        let banner_type = 'TB'
        top_banner_data.append('banner_type', banner_type)

        fetch(top_banner_form.action, {
            method: 'POST',
            body: top_banner_data,
            headers:{
                'X-CSRFToken': getCookie('csrftoken')
            }

        })

            .then(function (response){
                console.log('Ответ c бэкэнда', response);
                return response.json()
            })
            .then(function (data) {
                if (data.success) {
                    $('#successModal').modal('show');
                }
            })

            // .then(function (response) {
            //     return response.json();
            // })
    })


    document.querySelectorAll('.btn-group button').forEach(btn => {
    btn.addEventListener('click', function() {
        const speedInput = document.getElementById('id_top_banner_form-speed');
        if (!speedInput) return;
        // ставим значение кнопки
        speedInput.value = this.dataset.value;
        // подсветка активной кнопки
        this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    });
});



    /// Кнопка добьавит на верхний баннер
    const top_banner_wrapper = document.getElementById('top_banner-wrapper');
    const total_form_top_banner = document.getElementById('id_top_banner_formset-TOTAL_FORMS')
    const empty_top_banner_from = document.getElementById('empty-top-banner-form').querySelector('.top-banner-item')
    const top_banner_container = document.getElementById('top_banner-container')


    top_banner_wrapper.addEventListener('change', function (even){
        if (even.target.type === 'file') {
            const reader = new FileReader();

            /// если в событии тип фаил то запипсываю фаил в костанту
            const file = even.target.files[0];
            /// тут получаю место где лежит старая картинка или плейсхолдер
            const img = even.target.closest('.top-banner-item').querySelector('.preview');


            // тут я обращаюсь к reader и меняю старое фото на новое
            reader.onload = function (e) {
                img.src = e.target.result
            };
                // передаю путь к изображени в url формате для вывода
            reader.readAsDataURL(file)
        }})



    top_banner_wrapper.addEventListener('click', function (even) {

        /// Добавление картинки

        if (even.target.classList.contains('upload-btn')) {
            const input = even.target.closest('.top-banner-item').querySelector('input[type="file"]');
            input.click();

        }

            /// Удаление формы
        if (even.target.classList.contains('remove-image')) {
            const block_top_banner_form = even.target.closest('.top-banner-item');

            const delete_input = block_top_banner_form.querySelector('input[type="checkbox"][name$="-DELETE"]');
            const input_id = block_top_banner_form.querySelector('input[name$="-id"]');

            if (input_id && input_id.value) {
                if (delete_input) {
                    delete_input.checked = true;
                    block_top_banner_form.hidden = true;
                    console.log('удалил форму с юэкенда')
                }}
            else {
                block_top_banner_form.remove();
                total_form_top_banner.value = parseInt(total_form_top_banner.value) -1;
                 console.log('удалил форму с фронтенда')
            }





            // block_top_banner_form.remove();
            // total_form_top_banner.value = parseInt(total_form_top_banner.value) -1;
            // console.log(block_top_banner_form);
        }


        /// Добавление формы
        if (even.target.closest('#btn-add-top-banner-item')) {

            console.log('press btn');

            let top_banner_form_count = parseInt(total_form_top_banner.value);
            console.log('top_banner_form_count', top_banner_form_count);

            let new_form_top_banner = empty_top_banner_from.cloneNode(true);
            console.log('new_form_top_banner', new_form_top_banner);

            new_form_top_banner.innerHTML = new_form_top_banner.innerHTML.replace(/__prefix__/g, top_banner_form_count);
            total_form_top_banner.value = top_banner_form_count + 1;
            new_form_top_banner.hidden = false;
            top_banner_container.appendChild(new_form_top_banner);}



    })







    const news_banner_wrapper = document.getElementById('news_banner-wrapper');
    const total_form_news_banner = document.getElementById('id_news_banner_formset-TOTAL_FORMS')
    const empty_news_banner_form = document.getElementById('empty-news-banner-form').querySelector('.news-banner-item')
    const news_banner_container = document.getElementById('news_banner-container')

    news_banner_wrapper.addEventListener('click', function (even){

         if (even.target.classList.contains('upload-btn')) {
            const input = even.target.closest('.news-banner-item').querySelector('input[type="file"]');
            input.click();

        }

        // добавление формы
        if (even.target.closest('#btn-add-news-banner-item')) {
            let news_banner_form_count = parseInt(total_form_news_banner.value);
            let new_form_news_banner = empty_news_banner_form.cloneNode(true);
            new_form_news_banner.innerHTML = new_form_news_banner.innerHTML.replace(/__prefix__/g, news_banner_form_count);
            total_form_news_banner.value = news_banner_form_count + 1;
            new_form_news_banner.hidden = false;
            news_banner_container.appendChild(new_form_news_banner);
        }
            /// удаление фыормы
         if (even.target.classList.contains('remove-image')) {

            const block_news_banner_form = even.target.closest('.news-banner-item');

            const delete_input = block_news_banner_form.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (delete_input) {
                block_news_banner_form.checked = true;
            }
            block_news_banner_form.style.display = 'none';

            // block_news_banner_form.remove();
            // total_form_news_banner.value = parseInt(total_form_news_banner.value) -1;
            // console.log(block_news_banner_form);
        }
    })

    news_banner_wrapper.addEventListener('change', function (even){
        if (even.target.type === 'file') {
            const reader = new FileReader();

            /// если в событии тип фаил то запипсываю фаил в костанту
            const file = even.target.files[0];
            /// тут получаю место где лежит старая картинка или плейсхолдер
            const img = even.target.closest('.news-banner-item').querySelector('.preview');


            // тут я обращаюсь к reader и меняю старое фото на новое
            reader.onload = function (e) {
                img.src = e.target.result
            };
                // передаю путь к изображени в url формате для вывода
            reader.readAsDataURL(file)
        }})













    $(document).ready(function () {
    $('.status-toggle').bootstrapToggle({
        on: 'ВКЛ',
        off: 'ВЫКЛ',
        onstyle: 'success',
        offstyle: 'danger',
        size: 'small'
    });
});
});

</script>


{% endblock%}

