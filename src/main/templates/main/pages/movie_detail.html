
{% extends "main/base_page.html" %}
{% load i18n %}

{%block content%}


<style>
   .custom-carousel-item {
    aspect-ratio: 16 / 9;
}

.custom-carousel-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}


</style>






<div class="container mt-2   p-4" style="background-color: #313549; max-width: 1200px ">


    <div class="movieTrailer">
        <div class="embed-responsive embed-responsive-16by9">
          <iframe class="embed-responsive-item" src="https://www.youtube.com/watch?v=YUiQ6X3ari0&list=PLVy9V60nLCW02EfHIxF6VTYCT6V_hJ_Cq" allowfullscreen></iframe>
        </div>
    </div>





    <div class="SessionSchedule">
        <div>
           <label for="cinemaSelect" class="mr-2 mb-0 ">
               Расписание сеансов кинотеатра:
           </label>
            <select id="cinemaSelect" class="form-control w-auto d-inline-block">
                <option value="" selected disabled>
                    Выберите кинотеатр
                </option>
                {% for cinema in cinemas %}<option value="{{ cinema.id }}">
                {{ cinema.title }}
            </option>
                {% endfor %}
            </select>
        </div>


<!--        контейнер с кнопоками 3д и ДНИ С-->
        <div class="ButtonContainer" id="ButtonContainer">
            <div class="btn-group-format rounded-3 p-1">
                <button class="btn btn-outline-light active" data-format="">Все</button>
                <button class="btn btn-outline-light" data-format="2D">2D</button>
                <button class="btn btn-outline-light" data-format="3D">3D</button>
            </div>
        </div>
    </div>




    <div class="DateContainer" id="DateContainer">
        <div class="btn-group-dates bg-olive rounded-3 p-1">
            {% for day in movie.rental_days %}
            <button class="btn btn-outline-light date-btn {% if forloop.first %}active{% endif %}"
                    data-date="{{ day|date:'Y-m-d' }}">
                {{ day|date:"j M" }}
            </button>
            {% endfor %}
        </div>
    </div>
</div>







<div class="container mt-2 p-4 " style="background-color: #313549; max-width: 1200px ">
    <div class="card text-center" style="background-color: #313549;">
        <div class="card-header row ">
            <div class="card" style="width: 18rem; background-color: #394055">
                <img class="card-img-top" src="{{movie.main_image.url }}" alt="Card image cap">
                <div class="card-body">
                    <p class="card-text">{{movie.title}}</p>
                </div>
            </div>


            <div class="card" style="width: 18rem;  margin-left: auto; background-color: #394055">
                <div class="card-body">
                    <h5 class="card-title">СЕАНСЫ</h5>

                    <div id="scheduleContainer">
                        Выберите дату и кинотеатр
                    </div>



                </div>
            </div>


            <div class="card " style="width: 18rem; margin-left: auto; background-color: #394055">
                <div class="card-body">
                    <h5 class="card-title">Описсние</h5>
                    <p class="card-text">{{movie.description}}</p>
                </div>
            </div>


        </div>

        <div class="card-body">
            <h5 class="card-title">Кадры и постеры</h5>
            <div id="carouselExampleIndicators{{ forloop.counter }}"
                 class="carousel slide " data-interval="2000"
                 data-ride="carousel">

                <ol class="carousel-indicators">
                    {% for slide in movie.gallery.all %}
                    <li data-target="#carouselExampleIndicators{{ forloop.parentloop.counter }}"
                        data-slide-to="{{ forloop.counter0 }}"
                        class="{% if forloop.first %}active{% endif %}">
                    </li>
                    {% endfor %}
                </ol>

                <div class="carousel-inner">
                    {% for slide in movie.gallery.all %}
                    <div class="carousel-item custom-carousel-item {% if forloop.first %}active{% endif %}">
                        <img class="d-block w-100" src="{{ slide.image.url }}" alt="">
                    </div>
                    {% endfor %}
                </div>

                <a class="carousel-control-prev"
                   href="#carouselExampleIndicators{{ forloop.counter }}"
                   role="button"
                   data-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </a>

                <a class="carousel-control-next"
                   href="#carouselExampleIndicators{{ forloop.counter }}"
                   role="button"
                   data-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </a>
            </div>
            <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
        </div>

        <div class="card-footer text-muted">
            2 days ago
        </div>
    </div>
</div>

<script>


    const typeSelect = document.getElementById("ButtonContainer");
    const dateDisplay = document.getElementById("DateContainer");
    const cinemaSelect = document.getElementById("cinemaSelect");

    typeSelect.style.display = "none";
    dateDisplay.style.display = "none";

    cinemaSelect.addEventListener('change', function (e){
        if (this.value) {
            dateDisplay.style.display = "block";
            typeSelect.style.display = "block";
            loadSchedules()
        }
    })




/// отвачет за кнопки с датой
    const dateBtn = document.querySelectorAll(".date-btn");
    dateBtn.forEach(function (button){
        button.addEventListener('click', function (e){

            ///  убираю активный класс с кнопки
            dateBtn.forEach(function (btn){
                btn.classList.remove("active")

            })
            button.classList.add("active")

            const dateSession = button.dataset.date;
            console.log("Выбрана дата:", dateSession);
            loadSchedules();

        })
    })

    // отвечает за тип фильма 3д и т.д
    const formatBtn = document.querySelectorAll(".btn-group-format .btn");

    formatBtn.forEach(function (button) {
        button.addEventListener('click', function (e) {
            formatBtn.forEach(function (btn) {
                btn.classList.remove('active')
            })
            button.classList.add('active')
            const formatMovie = button.dataset.format;
            console.log(formatMovie)
            loadSchedules()
        })
    })








    function loadSchedules() {
        const cinemaId = document.getElementById("cinemaSelect")?.value;
        const dateSession = document.querySelector(".date-btn.active")?.dataset.date;
        const formatMovie = document.querySelector('.btn-group-format .active').dataset.format;
        console.log(cinemaId)
        console.log(dateSession)
        console.log('отправляю дату',dateSession)
        const container = document.getElementById("scheduleContainer");



        fetch(`/movie/{{ movie.id }}/schedules/?date=${dateSession}&cinema=${cinemaId}&format=${formatMovie}`)
            .then(function (res) {
                return res.json()
            })

            .then(function (data) {
                container.innerHTML = "";
                 data.schedules.forEach(s => {
                container.innerHTML += `
                    <div class="mb-2 p-2 border rounded">
                    <a href="/booking/${s.id}/" class="btn btn-block btn-light btn-lg" >
                        <div><strong>${s.time}</strong></div>
                        <div>Зал: ${s.hall}</div>
                        <div>Формат: ${s.format}</div>
                        <div>Цена: ${s.price ?? "—"} грн</div>
                        </a>
                    </div>
                `;})

            console.log(data)})

    }


</script>

{%endblock%}
